var express=require("express"),router=express.Router(),routeSql=require("../sql/routeSql.js"),jwt=require("jwt-simple"),app=express(),Ipconfig=require("../Ipconfig/Ipconfig.js").Ipconfig,Sequelize=require("sequelize"),sequelize=require("../sql/sqlConnect.js");app.set("jwtTokenSecret","JingGe"),router.post("/TrainCourses/List",function(e,r){var t=Ipconfig.SaveServer.SaveServerIpHost+":"+Ipconfig.SaveServer.SaveServerIpPort;parseInt(e.headers.insert)&&(t=Ipconfig.InSertIp.InSertIpHost+":"+Ipconfig.InSertIp.InSertIpPort);var o,n=e.body.limit,s=parseInt(n),i=(e.body.page-1)*n,a=e.body.msg;routeSql.TrainCourses.count({where:{IsDeleted:!1,Title:{$like:"%"+a+"%"}}}).then(function(e){o=e});var u=[{model:routeSql.TrainCourseCategories,as:"CategoryName",attributes:["Id","Name","CreationTime"]}],d=[["CreationTime","DESC"]];d=e.body.order?""==e.body.order.name?[["CreationTime",e.body.order.sort?"ASC":"DESC"]]:"Title"==e.body.order.name?[[{model:routeSql.TrainCourses},"Title",e.body.order.sort?"ASC":"DESC"]]:"Price"==e.body.order.name?[[{model:routeSql.CourseExpands,as:"TrainCoursesCourseExpands"},"Price",e.body.order.sort?"ASC":"DESC"]]:"PayType"==e.body.order.name?[[{model:routeSql.CourseExpands,as:"TrainCoursesCourseExpands"},"PayType",e.body.order.sort?"ASC":"DESC"]]:"TrainCourseType"==e.body.order.name?[[{model:routeSql.CourseExpands,as:"TrainCoursesCourseExpands"},"TrainCourseType",e.body.order.sort?"ASC":"DESC"]]:"LabelId"==e.body.order.name?[[{model:routeSql.CourseLabels,as:"CourseLabelsTrainCourseId"},"LabelId",e.body.order.sort?"ASC":"DESC"]]:[["CreationTime","DESC"]]:[["CreationTime","DESC"]],routeSql.TrainCourses.findAll({attributes:["Id","Title",[sequelize.fn("Nullif",sequelize.fn("CONCAT",t,sequelize.col("Thumb")),t),"Thumb"],"Summary","CreationTime","TrainCourseCategoryId"],where:{IsDeleted:!1,Title:{$like:"%"+a+"%"}},include:u,order:d,offset:i,limit:s}).then(function(e){var t={};t.count=o,t.data=e,r.send(t)}).catch(function(e){r.send(e)})}),router.post("/traincourses/destory",function(e,r){var t=e.headers.token,o=jwt.decode(t,app.get("jwtTokenSecret")),n=e.body.Id;routeSql.ClassAndCourses.findAll({where:{TrainCourseId:n}}).then(function(e){e.length>0?r.send({error:1,result:{msg:"有班级关联该课程，无法删除"}}):routeSql.TrainCourses.update({IsDeleted:!0,DeleterUserId:o.Id,DeletionTime:new Date},{where:{Id:n}}).then(function(){r.send({error:0,result:{msg:"删除成功"}})})})}),router.get("/traincourses/edit",function(e,r){var t=Ipconfig.SaveServer.SaveServerIpHost+":"+Ipconfig.SaveServer.SaveServerIpPort;parseInt(e.headers.insert)&&(t=Ipconfig.InSertIp.InSertIpHost+":"+Ipconfig.InSertIp.InSertIpPort);var o=[{model:routeSql.TrainCourseCategories,as:"CategoryName",attributes:["Id","Name"]}];routeSql.TrainCourses.findOne({where:{Id:e.query.Id,IsDeleted:!1},attributes:["Id",[sequelize.fn("Nullif",sequelize.fn("CONCAT",t,sequelize.col("Thumb")),t),"Thumb"],"TrainCourseCategoryId","Title","Summary","IsPublic"],include:o}).then(function(e){r.send(e)})}),router.post("/traincourses/edit",function(e,r){var t=e.headers.token,o=jwt.decode(t,app.get("jwtTokenSecret"));""==e.body.Title||null==e.body.Title?r.send({error:2,result:{msg:"请输入正确的名称和描述"}}):e.body.Title.length<=30?routeSql.TrainCourses.update({Title:e.body.Title,Thumb:e.body.Thumb.substring(e.body.Thumb.indexOf(Ipconfig.SaveServer.SaveServerIpPort)+Ipconfig.SaveServer.SaveServerIpPort.toString().length),Summary:e.body.Summary,TrainCourseCategoryId:e.body.CategoryId,IsPublic:e.body.IsPublic,LastModificationTime:new Date,LastModifierUserId:o.Id},{where:{Id:e.body.Id}}).then(function(){r.send({error:0,result:{msg:"编辑成功"}})}):r.send({error:2,result:{msg:"请输入正确的名称和描述"}})}),router.get("/traincourses/station",function(e,r){function t(e){var n=new Object;(n=e.shift())?routeSql.TrainPeriods.findAll({where:{CourseSectionId:n.dataValues.Id},attributes:["Id","Title","CourseSectionId","Seq","ResourceId"]}).then(function(r){function s(r){var a=r.shift();a?routeSql.Resources.findOne({where:{Id:a.dataValues.ResourceId}}).then(function(e){period={Id:a.dataValues.Id,Title:a.dataValues.Title,CourseSectionId:a.dataValues.CourseSectionId,Seq:a.dataValues.Seq,ResourceId:a.dataValues.ResourceId,FileName:e.dataValues.FileName},i.push(period),s(r)}):(n.dataValues.periodArr=i,o.push(n.dataValues),t(e))}var i=[];s(r)}):r.send({error:0,result:o})}var o=[],n=[];routeSql.TrainCourseSections.findAll({where:{CourseId:e.query.Id},attributes:["Id","Seq","Title","CourseId"]}).then(function(e){t(n=e)})}),router.post("/traincourses/station",function(e,r){function t(e){var r=e.shift();r&&routeSql.TrainCourseSections.destroy({where:{Id:r}}).then(function(){routeSql.TrainPeriods.count({where:{CourseSectionId:r}}).then(function(e){u+=e}),routeSql.TrainPeriods.destroy({where:{CourseSectionId:r}}).then(function(){t(e)})})}function o(){function e(r,t){var n=r.shift();n?0!=n.Id?routeSql.TrainPeriods.update({Title:n.Title,ResourceId:n.ResourceId,CourseSectionId:t},{where:{Id:n.Id}}).then(function(o){e(r,t)}):(I+=1,routeSql.TrainPeriods.max(["Seq"],{where:{CourseSectionId:t}}).then(function(o){o||(o=0),routeSql.TrainPeriods.create({Title:n.Title,Seq:o+1,ResourceId:n.ResourceId,CourseSectionId:t,IsRelease:!1,assetType:0,CreationTime:new Date,CreatorUserId:s.Id,IsPreview:0}).then(function(o){e(r,t)})})):o()}var t=d.shift();t?0!=t.Id?routeSql.TrainCourseSections.update({Title:t.Title,CourseId:l},{where:{Id:t.Id}}).then(function(r){e(t.periodArr,t.Id)}):routeSql.TrainCourseSections.max(["Seq"]).then(function(r){r||(r=0),routeSql.TrainCourseSections.create({Title:t.Title,Seq:r+1,CourseId:l,IsRelease:!1,courseType:3,CreationTime:new Date,CreatorUserId:s.Id}).then(function(r){I+=t.periodArr.length,e(t.periodArr,r.dataValues.Id)})}):(r.send({error:0,result:{msg:"编辑成功"}}),routeSql.TrainCourses.findOne({where:{Id:l}}).then(function(e){routeSql.TrainCourseAnalysis.findOne({where:{Id:e.dataValues.TrainCourseAnalysisId}}).then(function(r){routeSql.TrainCourseAnalysis.update({PeriodNum:r.dataValues.PeriodNum+I-u},{where:{Id:e.dataValues.TrainCourseAnalysisId}})})}))}var n=e.headers.token,s=jwt.decode(n,app.get("jwtTokenSecret")),i=[];i=e.body.deleted.deletedSecArr;var a=[];a=e.body.deleted.deletedPerArr;var u=0;0!=i.length&&t(i),0!=a.length&&(routeSql.TrainPeriods.count({where:{Id:a}}).then(function(e){u+=e}),routeSql.TrainPeriods.destroy({where:{Id:a}}));var d=e.body.updated.arr,l=e.body.updated.CourseId,I=0;o()}),router.post("/trainCourses/createTrainCourse",function(e,r){new Date;var t=[{model:routeSql.TrainCourseAnalysis,as:"TrainCoursesTrainCourseAnalysisId"}];""==e.body.Title||null==e.body.Title?r.send({error:2,result:{msg:"请输入正确的名称和描述"}}):e.body.Title.length<=20?routeSql.TrainCourses.create({Title:e.body.Title,Summary:e.body.Summary,IsRelease:!1,TenantId:1,Thumb:e.body.Thumb.substring(e.body.Thumb.indexOf(Ipconfig.SaveServer.SaveServerIpPort)+Ipconfig.SaveServer.SaveServerIpPort.toString().length),CreationTime:new Date,TrainCourseCategoryId:e.body.CategoryId,IsDeleted:!1,Credit:0,IsPublic:!e.body.IsPublic||e.body.IsPublic,TrainCoursesTrainCourseAnalysisId:[{StudentNum:0,Rating:0,RatingNum:0,PeriodNum:0,CollectNum:0,ShareNum:0,PraiseNum:0,BrowseNum:0}]},{include:t}).then(function(e){r.send({error:0,result:{CourseId:e.dataValues.Id.toString()}})}):r.send({error:2,result:{msg:"请输入正确的名称和描述"}})}),router.post("/TrainCourses/createSection",function(e,r){function t(e){var t=e.shift();t?routeSql.TrainCourseSections.max(["Seq"]).then(function(r){r||(r=0),routeSql.TrainCourseSections.create({Title:t.Title,Seq:r+1,CourseId:a,IsRelease:!1,courseType:3,CreationTime:new Date,CreatorUserId:s.Id}).then(function(r){o(e,t.periodArr,r.dataValues.Id)})}):r.send({error:0,result:{msg:"保存成功"}})}function o(e,r,n){var i=r.shift();i?routeSql.TrainPeriods.max(["Seq"]).then(function(t){t||(t=0),routeSql.TrainPeriods.create({Title:i.Title,Seq:t+1,ResourceId:i.ResourceId,CourseSectionId:n,IsRelease:!1,assetType:0,CreationTime:new Date,CreatorUserId:s.Id,IsPreview:0}).then(function(){o(e,r,n)})}):t(e)}for(var n=e.headers.token,s=jwt.decode(n,app.get("jwtTokenSecret")),i=e.body.arr,a=e.body.CourseId,u=0,d=0;d<i.length;d++)u+=i[d].periodArr.length;routeSql.TrainCourses.findOne({where:{Id:a}}).then(function(e){routeSql.TrainCourseAnalysis.findOne({where:{Id:e.dataValues.TrainCourseAnalysisId}}).then(function(r){routeSql.TrainCourseAnalysis.update({PeriodNum:r.dataValues.PeriodNum+u},{where:{Id:e.dataValues.TrainCourseAnalysisId}})})}),t(i)}),module.exports=router;